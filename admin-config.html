<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Config Manager | Venue Manager Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- SECURITY GATEKEEPER -->
    <script>
        if (!localStorage.getItem('vp_token')) { window.location.href = 'login.html'; }
    </script>

    <style>
        :root {
            --bg-dark: #0f172a;
            --bg-card: rgba(30, 41, 59, 0.9);
            --border: rgba(148, 163, 184, 0.1);
            --primary: #6366f1;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --sidebar-width: 260px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; }
        body {
            background-color: var(--bg-dark);
            background-image: radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%);
            color: var(--text-main); min-height: 100vh; display: flex; overflow-x: hidden;
        }

        /* SIDEBAR */
        aside { width: var(--sidebar-width); background: rgba(15,23,42,0.95); border-right: 1px solid var(--border); padding: 2rem; display: flex; flex-direction: column; position: fixed; height: 100vh; z-index: 100; transition: transform 0.3s ease; }
        .brand { font-size: 1.5rem; font-weight: 700; color: white; display: flex; align-items: center; justify-content: space-between; margin-bottom: 3rem; }
        .nav-link { display: flex; align-items: center; gap: 12px; padding: 12px 16px; color: var(--text-muted); text-decoration: none; border-radius: 8px; margin-bottom: 5px; transition: all 0.2s; font-weight: 500; }
        .nav-link:hover, .nav-link.active { background: rgba(99,102,241,0.1); color: var(--primary); }
        .close-sidebar { display: none; background: none; border: none; color: white; font-size: 1.2rem; cursor: pointer; }

        /* MAIN */
        main { margin-left: var(--sidebar-width); flex: 1; padding: 2rem; width: 100%; transition: margin-left 0.3s ease; }
        header { display: flex; align-items: center; margin-bottom: 2rem; gap: 1rem; }
        .menu-toggle { display: none; background: var(--bg-card); border: 1px solid var(--border); color: white; width: 40px; height: 40px; border-radius: 8px; align-items: center; justify-content: center; cursor: pointer; }

        /* TABS */
        .tab-bar { display: flex; gap: 8px; margin-bottom: 2rem; background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 6px; width: fit-content; }
        .tab-btn { padding: 10px 24px; border: none; border-radius: 8px; background: transparent; color: var(--text-muted); font-weight: 600; cursor: pointer; transition: all 0.2s; font-size: 0.9rem; white-space: nowrap; }
        .tab-btn.active { background: var(--primary); color: white; }
        .tab-panel { display: none; }
        .tab-panel.active { display: block; }

        /* CARD */
        .card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; padding: 2rem; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .card-title { font-size: 1.1rem; font-weight: 700; border-bottom: 1px solid var(--border); padding-bottom: 1rem; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 10px; }
        .grid-split { display: grid; grid-template-columns: 1fr 1.6fr; gap: 2rem; }

        /* FORM */
        .input-group { margin-bottom: 1rem; }
        .input-group label { display: block; color: var(--text-muted); font-size: 0.8rem; font-weight: 600; text-transform: uppercase; margin-bottom: 0.5rem; }
        input[type=text], input[type=number], input[type=password], textarea, select {
            width: 100%; padding: 11px 14px; background: rgba(0,0,0,0.2); border: 1px solid var(--border);
            border-radius: 10px; color: white; outline: none; font-size: 0.95rem; transition: border 0.3s; font-family: inherit;
        }
        input:focus, textarea:focus, select:focus { border-color: var(--primary); }
        textarea { resize: vertical; min-height: 70px; }
        select option { background: #1e293b; }
        .row2 { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .btn { width: 100%; padding: 13px; border: none; border-radius: 10px; font-weight: 700; cursor: pointer; transition: 0.2s; font-size: 0.95rem; margin-top: 0.5rem; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: #4f46e5; }
        .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-warning { background: rgba(245,158,11,0.2); color: var(--warning); border: 1px solid rgba(245,158,11,0.3); }
        .btn-warning:hover { background: var(--warning); color: #0f172a; }

        /* TABLE */
        .table-wrap { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 420px; }
        th { text-align: left; padding: 0.85rem 1rem; color: var(--text-muted); font-size: 0.75rem; text-transform: uppercase; border-bottom: 1px solid var(--border); white-space: nowrap; }
        td { padding: 0.85rem 1rem; border-bottom: 1px solid var(--border); font-size: 0.9rem; vertical-align: middle; }
        tr:last-child td { border-bottom: none; }
        .inactive-row { opacity: 0.45; }
        .status-badge { padding: 3px 9px; border-radius: 20px; font-size: 0.72rem; font-weight: 700; text-transform: uppercase; }
        .status-active   { background: rgba(16,185,129,0.15); color: var(--success); }
        .status-inactive { background: rgba(239,68,68,0.15);  color: var(--danger); }
        .action-btns { display: flex; gap: 6px; justify-content: flex-end; }
        .btn-sm { padding: 5px 11px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.78rem; font-weight: 700; transition: 0.2s; }
        .btn-edit   { background: rgba(99,102,241,0.2); color: var(--primary); }
        .btn-edit:hover   { background: var(--primary); color: white; }
        .btn-delete { background: rgba(239,68,68,0.2); color: var(--danger); }
        .btn-delete:hover { background: var(--danger); color: white; }
        .btn-restore { background: rgba(16,185,129,0.2); color: var(--success); }
        .btn-restore:hover { background: var(--success); color: white; }

        /* PRICING GRID */
        .pricing-table-wrap { overflow-x: auto; }
        .pricing-grid { border-collapse: collapse; min-width: 600px; }
        .pricing-grid th, .pricing-grid td { padding: 10px 14px; border: 1px solid var(--border); text-align: center; }
        .pricing-grid th:first-child { text-align: left; min-width: 140px; }
        .pricing-grid thead th { color: var(--text-muted); font-size: 0.75rem; text-transform: uppercase; background: rgba(0,0,0,0.2); }
        .pricing-cell { position: relative; }
        .price-input {
            width: 90px; padding: 5px 8px; background: rgba(0,0,0,0.3); border: 1px solid var(--border);
            border-radius: 6px; color: white; font-size: 0.85rem; text-align: center; outline: none;
        }
        .price-input:focus { border-color: var(--primary); }
        .price-input.unsaved { border-color: var(--warning); }
        .save-cell-btn { position: absolute; right: 2px; top: 50%; transform: translateY(-50%); background: var(--success); color: white; border: none; border-radius: 4px; padding: 3px 7px; font-size: 0.7rem; cursor: pointer; display: none; }
        .pricing-cell:hover .save-cell-btn { display: block; }
        .room-label { font-weight: 600; text-align: left !important; color: var(--text-main); }
        .rate-default { font-size: 0.7rem; color: var(--text-muted); display: block; margin-top: 2px; }

        /* MODAL */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.65); z-index: 200; backdrop-filter: blur(3px); align-items: center; justify-content: center; }
        .modal-overlay.open { display: flex; }
        .modal { background: #1e293b; border: 1px solid var(--border); border-radius: 16px; padding: 2rem; width: 100%; max-width: 480px; max-height: 90vh; overflow-y: auto; }
        .modal-title { font-size: 1.1rem; font-weight: 700; margin-bottom: 1.5rem; display: flex; justify-content: space-between; align-items: center; }
        .modal-close { background: none; border: none; color: var(--text-muted); font-size: 1.2rem; cursor: pointer; }
        .modal-close:hover { color: white; }
        .toggle-row { display: flex; align-items: center; justify-content: space-between; padding: 10px 0; }
        .toggle-label { font-size: 0.9rem; color: var(--text-muted); }
        .toggle { width: 44px; height: 24px; background: rgba(148,163,184,0.2); border-radius: 12px; border: none; cursor: pointer; position: relative; transition: 0.3s; }
        .toggle::after { content:''; position: absolute; width: 18px; height: 18px; background: white; border-radius: 50%; top: 3px; left: 3px; transition: 0.3s; }
        .toggle.on { background: var(--success); }
        .toggle.on::after { left: 23px; }

        /* TOAST */
        #toast { position: fixed; bottom: 2rem; right: 2rem; padding: 1rem 1.5rem; border-radius: 10px; font-weight: 600; z-index: 999; transform: translateY(100px); opacity: 0; transition: all 0.3s; pointer-events: none; }
        #toast.show { transform: translateY(0); opacity: 1; }
        #toast.success { background: var(--success); color: white; }
        #toast.error   { background: var(--danger);  color: white; }

        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 90; backdrop-filter: blur(2px); }
        .overlay.active { display: block; }

        @media (max-width: 900px) { .grid-split { grid-template-columns: 1fr; } }
        @media (max-width: 768px) { aside { transform: translateX(-100%); } aside.active { transform: translateX(0); } main { margin-left: 0; padding: 1rem; } .menu-toggle { display: flex; } .close-sidebar { display: block; } }
    </style>
</head>
<body>

<div class="overlay" id="overlay" onclick="toggleMenu()"></div>

<!-- SIDEBAR -->
<aside id="sidebar">
    <div class="brand">
        <span><i class="fa-solid fa-layer-group"></i> VenuePro</span>
        <button class="close-sidebar" onclick="toggleMenu()"><i class="fa-solid fa-xmark"></i></button>
    </div>
    <nav>
        <a href="index.html"           class="nav-link"><i class="fa-solid fa-chart-pie"></i> Dashboard</a>
        <a href="bookings.html"        class="nav-link"><i class="fa-solid fa-calendar-days"></i> Bookings</a>
        <a href="customers.html"       class="nav-link"><i class="fa-solid fa-users"></i> Customers</a>
        <a href="accounts.html"        class="nav-link"><i class="fa-solid fa-file-invoice-dollar"></i> Accounts</a>
        <a href="venuepro_booking.html" class="nav-link"><i class="fa-solid fa-building"></i> Event Booking</a>
        <a href="final-payment.html"   class="nav-link"><i class="fa-solid fa-check-double"></i> Final Payment</a>
        <a href="calendar.html"        class="nav-link"><i class="fa-solid fa-calendar-alt"></i> Calendar</a>
        <a href="users.html"           class="nav-link"><i class="fa-solid fa-user-shield"></i> Users</a>
        <a href="admin-config.html"    class="nav-link active"><i class="fa-solid fa-sliders"></i> Config</a>
        <a href="#" onclick="logout()" class="nav-link" style="margin-top:auto;color:#ef4444;border-top:1px solid rgba(255,255,255,0.05);">
            <i class="fa-solid fa-right-from-bracket"></i> Logout
        </a>
    </nav>
</aside>

<!-- EDIT MODAL -->
<div class="modal-overlay" id="editModal">
    <div class="modal">
        <div class="modal-title">
            <span id="modalTitle">Edit</span>
            <button class="modal-close" onclick="closeModal()"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div id="modalBody"></div>
        <button class="btn btn-primary" id="modalSaveBtn" onclick="saveModal()" style="margin-top:1.5rem;">
            <i class="fa-solid fa-floppy-disk"></i> Save Changes
        </button>
    </div>
</div>

<!-- TOAST -->
<div id="toast"></div>

<main>
    <header>
        <button class="menu-toggle" onclick="toggleMenu()"><i class="fa-solid fa-bars"></i></button>
        <h1 style="font-size:1.8rem;font-weight:700;"><i class="fa-solid fa-sliders" style="color:var(--primary);margin-right:10px;"></i>Config Manager</h1>
    </header>

    <!-- TAB BAR -->
    <div class="tab-bar">
        <button class="tab-btn active" onclick="switchTab('rooms')"><i class="fa-solid fa-door-open"></i> Rooms</button>
        <button class="tab-btn"        onclick="switchTab('events')"><i class="fa-solid fa-calendar-star"></i> Event Types</button>
        <button class="tab-btn"        onclick="switchTab('pricing')"><i class="fa-solid fa-sterling-sign"></i> Pricing Grid</button>
        <button class="tab-btn"        onclick="switchTab('settings')"><i class="fa-solid fa-gear"></i> Settings</button>
    </div>

    <!-- ═══════════════════════════════════════ -->
    <!-- TAB: ROOMS                              -->
    <!-- ═══════════════════════════════════════ -->
    <div class="tab-panel active" id="tab-rooms">
        <div class="grid-split">
            <!-- ADD ROOM -->
            <div class="card">
                <div class="card-title"><i class="fa-solid fa-plus"></i> Add Room</div>
                <form onsubmit="return false;">
                    <div class="input-group">
                        <label>Room Name</label>
                        <input type="text" id="rName" placeholder="e.g. Garden Suite">
                    </div>
                    <div class="row2">
                        <div class="input-group">
                            <label>Capacity</label>
                            <input type="number" id="rCapacity" placeholder="e.g. 80" min="1">
                        </div>
                        <div class="input-group">
                            <label>Day Rate (£)</label>
                            <input type="number" id="rDayRate" placeholder="e.g. 950" min="0" step="0.01">
                        </div>
                    </div>
                    <div class="input-group">
                        <label>Half-Day Rate (£) <span style="font-size:0.75rem;opacity:0.6">optional</span></label>
                        <input type="number" id="rHalfRate" placeholder="e.g. 600" min="0" step="0.01">
                    </div>
                    <div class="input-group">
                        <label>Description</label>
                        <textarea id="rDesc" placeholder="Short description of facilities..."></textarea>
                    </div>
                    <button class="btn btn-primary" id="addRoomBtn" onclick="addRoom()">
                        <i class="fa-solid fa-plus"></i> Add Room
                    </button>
                </form>
            </div>

            <!-- ROOM LIST -->
            <div class="card">
                <div class="card-title"><i class="fa-solid fa-door-open"></i> Rooms</div>
                <div class="table-wrap">
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Cap.</th>
                                <th>Day Rate</th>
                                <th>Status</th>
                                <th style="text-align:right">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="roomsTable">
                            <tr><td colspan="5" style="text-align:center;padding:2rem;color:var(--text-muted)">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- ═══════════════════════════════════════ -->
    <!-- TAB: EVENT TYPES                        -->
    <!-- ═══════════════════════════════════════ -->
    <div class="tab-panel" id="tab-events">
        <div class="grid-split">
            <!-- ADD EVENT TYPE -->
            <div class="card">
                <div class="card-title"><i class="fa-solid fa-plus"></i> Add Event Type</div>
                <form onsubmit="return false;">
                    <div class="input-group">
                        <label>Event Type Name</label>
                        <input type="text" id="etName" placeholder="e.g. Corporate">
                    </div>
                    <div class="input-group">
                        <label>Description <span style="font-size:0.75rem;opacity:0.6">optional</span></label>
                        <textarea id="etDesc" placeholder="e.g. Business meetings and conferences"></textarea>
                    </div>
                    <button class="btn btn-primary" id="addEventTypeBtn" onclick="addEventType()">
                        <i class="fa-solid fa-plus"></i> Add Event Type
                    </button>
                </form>
            </div>

            <!-- EVENT TYPE LIST -->
            <div class="card">
                <div class="card-title"><i class="fa-solid fa-calendar-star"></i> Event Types</div>
                <div class="table-wrap">
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Description</th>
                                <th>Status</th>
                                <th style="text-align:right">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="eventTypesTable">
                            <tr><td colspan="4" style="text-align:center;padding:2rem;color:var(--text-muted)">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- ═══════════════════════════════════════ -->
    <!-- TAB: PRICING GRID                       -->
    <!-- ═══════════════════════════════════════ -->
    <div class="tab-panel" id="tab-pricing">
        <div class="card">
            <div class="card-title">
                <i class="fa-solid fa-sterling-sign"></i> Price Override Grid
                <span style="font-size:0.78rem;font-weight:400;color:var(--text-muted);margin-left:auto">
                    Set custom day rates per room + event type. Blank = uses room default rate.
                </span>
            </div>
            <div class="pricing-table-wrap" id="pricingGridWrap">
                <p style="color:var(--text-muted);text-align:center;padding:2rem">Loading...</p>
            </div>
        </div>
    </div>

    <!-- ═══════════════════════════════════════ -->
    <!-- TAB: SETTINGS                           -->
    <!-- ═══════════════════════════════════════ -->
    <div class="tab-panel" id="tab-settings">
        <div class="card" style="max-width:580px">
            <div class="card-title"><i class="fa-solid fa-clock-rotate-left"></i> Booking Turnaround Buffer</div>
            <p style="color:var(--text-muted);font-size:0.88rem;margin-bottom:1.5rem;line-height:1.6">
                The minimum gap required between back-to-back bookings in the same room.
                A new booking cannot start within this buffer period after an existing booking ends,
                and cannot end within this buffer period before an existing booking starts.
            </p>
            <div class="input-group">
                <label>Buffer Time</label>
                <select id="bufferSelect" onchange="handleBufferSelectChange()">
                    <option value="0">No buffer (bookings can be back-to-back)</option>
                    <option value="30">30 minutes</option>
                    <option value="45">45 minutes</option>
                    <option value="60">60 minutes (recommended)</option>
                    <option value="90">90 minutes</option>
                    <option value="120">2 hours</option>
                    <option value="custom">Custom...</option>
                </select>
            </div>
            <div class="input-group" id="customBufferGroup" style="display:none">
                <label>Custom Buffer (minutes)</label>
                <input type="number" id="customBufferInput" min="0" max="480" step="5" placeholder="e.g. 75">
            </div>
            <div id="bufferCurrentInfo" style="font-size:0.82rem;color:var(--text-muted);margin-bottom:1rem;padding:8px 12px;background:rgba(0,0,0,0.2);border-radius:8px;">
                <i class="fa-solid fa-circle-info"></i> <span id="bufferCurrentText">Loading current setting...</span>
            </div>
            <button class="btn btn-primary" id="saveBufferBtn" onclick="saveBufferSetting()">
                <i class="fa-solid fa-floppy-disk"></i> Save Buffer Setting
            </button>
        </div>
    </div>
</main>

<script>
// ─────────────────────────────────────────────
// CONFIG
// ─────────────────────────────────────────────
const BASE = 'https://n8n.srv1090894.hstgr.cloud/webhook';
const API = {
    getRooms:       BASE + '/get-rooms',
    createRoom:     BASE + '/create-room',
    updateRoom:     BASE + '/update-room',
    deleteRoom:     BASE + '/delete-room',
    getEventTypes:  BASE + '/get-event-types',
    createEventType:BASE + '/create-event-type',
    updateEventType:BASE + '/update-event-type',
    deleteEventType:BASE + '/delete-event-type',
    getPricing:     BASE + '/get-pricing',
    setPricing:     BASE + '/set-pricing',
    getSettings:    BASE + '/get-settings',
    updateSetting:  BASE + '/update-setting',
};

function getAuthHeaders() {
    return {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + (localStorage.getItem('vp_token') || '')
    };
}
function withRole(obj) {
    const u = JSON.parse(localStorage.getItem('vp_user') || '{}');
    return { ...obj, userRole: u.role || 'admin' };
}

// ─────────────────────────────────────────────
// STATE
// ─────────────────────────────────────────────
let rooms = [], eventTypes = [], pricing = [], settings = [];
let modalMode = null; // { type: 'room'|'event', id, data }

// ─────────────────────────────────────────────
// UTILITY
// ─────────────────────────────────────────────
function toggleMenu() {
    document.getElementById('sidebar').classList.toggle('active');
    document.getElementById('overlay').classList.toggle('active');
}
function logout() {
    if (confirm('Log out?')) { localStorage.removeItem('vp_token'); window.location.href = 'login.html'; }
}
function showToast(msg, type = 'success') {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.className = 'show ' + type;
    setTimeout(() => { t.className = ''; }, 3200);
}
function fmt(n) { return n != null ? '£' + parseFloat(n).toLocaleString('en-GB', { minimumFractionDigits: 2 }) : '—'; }

function switchTab(name) {
    document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById('tab-' + name).classList.add('active');
    event.target.closest('.tab-btn').classList.add('active');
    if (name === 'pricing')  renderPricingGrid();
    if (name === 'settings') loadSettings();
}

// ─────────────────────────────────────────────
// ROOMS
// ─────────────────────────────────────────────
async function loadRooms() {
    try {
        const res = await fetch(API.getRooms, { headers: getAuthHeaders() });
        const json = await res.json();
        rooms = json.data || (Array.isArray(json) ? json : []);
        renderRoomsTable();
    } catch(e) {
        document.getElementById('roomsTable').innerHTML =
            '<tr><td colspan="5" style="text-align:center;color:var(--danger)">Failed to load rooms</td></tr>';
    }
}

function renderRoomsTable() {
    const tbody = document.getElementById('roomsTable');
    if (!rooms.length) { tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--text-muted)">No rooms found.</td></tr>'; return; }
    tbody.innerHTML = rooms.map(r => `
        <tr class="${!r.is_active ? 'inactive-row' : ''}">
            <td style="font-weight:600;color:white">${esc(r.name)}</td>
            <td style="color:var(--text-muted)">${r.capacity || '—'}</td>
            <td>${fmt(r.day_rate)}</td>
            <td><span class="status-badge ${r.is_active ? 'status-active' : 'status-inactive'}">${r.is_active ? 'Active' : 'Inactive'}</span></td>
            <td>
                <div class="action-btns">
                    <button class="btn-sm btn-edit" onclick="editRoom(${r.id})"><i class="fa-solid fa-pen"></i></button>
                    ${r.is_active
                        ? `<button class="btn-sm btn-delete" onclick="softDeleteRoom(${r.id}, '${esc(r.name)}')"><i class="fa-solid fa-eye-slash"></i></button>`
                        : `<button class="btn-sm btn-restore" onclick="restoreRoom(${r.id}, '${esc(r.name)}')"><i class="fa-solid fa-eye"></i></button>`
                    }
                </div>
            </td>
        </tr>`).join('');
}

async function addRoom() {
    const btn = document.getElementById('addRoomBtn');
    const name = document.getElementById('rName').value.trim();
    const cap  = document.getElementById('rCapacity').value;
    const dr   = document.getElementById('rDayRate').value;
    const hr   = document.getElementById('rHalfRate').value;
    const desc = document.getElementById('rDesc').value.trim();

    if (!name) { showToast('Room name is required', 'error'); return; }
    if (!dr || isNaN(parseFloat(dr))) { showToast('Day rate is required', 'error'); return; }

    btn.disabled = true; btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Adding...';
    try {
        const res = await fetch(API.createRoom, {
            method: 'POST', headers: getAuthHeaders(),
            body: JSON.stringify(withRole({ name, capacity: cap || null, day_rate: dr, half_rate: hr || null, description: desc || null }))
        });
        if (!res.ok) { const e = await res.json().catch(() => ({})); throw new Error(e.error || 'Failed'); }
        showToast('Room added!');
        ['rName','rCapacity','rDayRate','rHalfRate','rDesc'].forEach(id => document.getElementById(id).value = '');
        await loadRooms();
    } catch(e) { showToast(e.message || 'Error adding room', 'error'); }
    finally { btn.disabled = false; btn.innerHTML = '<i class="fa-solid fa-plus"></i> Add Room'; }
}

function editRoom(id) {
    const r = rooms.find(x => x.id == id);
    if (!r) return;
    modalMode = { type: 'room', id, data: r };
    document.getElementById('modalTitle').textContent = 'Edit Room — ' + r.name;
    document.getElementById('modalBody').innerHTML = `
        <div class="input-group"><label>Room Name</label><input type="text" id="me_name" value="${esc(r.name)}"></div>
        <div class="row2">
            <div class="input-group"><label>Capacity</label><input type="number" id="me_cap" value="${r.capacity || ''}" min="1"></div>
            <div class="input-group"><label>Day Rate (£)</label><input type="number" id="me_dr" value="${r.day_rate}" min="0" step="0.01"></div>
        </div>
        <div class="input-group"><label>Half-Day Rate (£)</label><input type="number" id="me_hr" value="${r.half_rate || ''}" min="0" step="0.01"></div>
        <div class="input-group"><label>Description</label><textarea id="me_desc">${esc(r.description || '')}</textarea></div>
        <div class="toggle-row">
            <span class="toggle-label">Room Active</span>
            <button class="toggle ${r.is_active ? 'on' : ''}" id="me_active" onclick="this.classList.toggle('on')"></button>
        </div>`;
    document.getElementById('editModal').classList.add('open');
}

async function saveModal() {
    if (!modalMode) return;
    const btn = document.getElementById('modalSaveBtn');
    btn.disabled = true; btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Saving...';

    try {
        if (modalMode.type === 'room') {
            const payload = {
                id:          modalMode.id,
                name:        document.getElementById('me_name').value.trim(),
                capacity:    document.getElementById('me_cap').value || null,
                day_rate:    document.getElementById('me_dr').value,
                half_rate:   document.getElementById('me_hr').value || null,
                description: document.getElementById('me_desc').value.trim() || null,
                is_active:   document.getElementById('me_active').classList.contains('on')
            };
            if (!payload.name) throw new Error('Room name is required');
            const res = await fetch(API.updateRoom, { method: 'POST', headers: getAuthHeaders(), body: JSON.stringify(withRole(payload)) });
            if (!res.ok) throw new Error('Update failed');
            showToast('Room updated!');
            await loadRooms();
        } else if (modalMode.type === 'event') {
            const payload = {
                id:          modalMode.id,
                name:        document.getElementById('me_name').value.trim(),
                description: document.getElementById('me_desc').value.trim() || null,
                is_active:   document.getElementById('me_active').classList.contains('on')
            };
            if (!payload.name) throw new Error('Name is required');
            const res = await fetch(API.updateEventType, { method: 'POST', headers: getAuthHeaders(), body: JSON.stringify(withRole(payload)) });
            if (!res.ok) throw new Error('Update failed');
            showToast('Event type updated!');
            await loadEventTypes();
        }
        closeModal();
    } catch(e) { showToast(e.message || 'Error saving', 'error'); }
    finally { btn.disabled = false; btn.innerHTML = '<i class="fa-solid fa-floppy-disk"></i> Save Changes'; }
}

async function softDeleteRoom(id, name) {
    if (!confirm(`Deactivate "${name}"? It won't appear in booking forms but historical data is kept.`)) return;
    try {
        await fetch(API.deleteRoom, { method: 'POST', headers: getAuthHeaders(), body: JSON.stringify(withRole({ room_id: id })) });
        showToast('Room deactivated');
        await loadRooms();
    } catch(e) { showToast('Error', 'error'); }
}

async function restoreRoom(id, name) {
    if (!confirm(`Re-activate "${name}"?`)) return;
    const r = rooms.find(x => x.id == id);
    if (!r) return;
    try {
        await fetch(API.updateRoom, {
            method: 'POST', headers: getAuthHeaders(),
            body: JSON.stringify(withRole({ ...r, id, is_active: true }))
        });
        showToast('Room re-activated');
        await loadRooms();
    } catch(e) { showToast('Error', 'error'); }
}

// ─────────────────────────────────────────────
// EVENT TYPES
// ─────────────────────────────────────────────
async function loadEventTypes() {
    try {
        const res = await fetch(API.getEventTypes, { headers: getAuthHeaders() });
        const json = await res.json();
        eventTypes = json.data || (Array.isArray(json) ? json : []);
        renderEventTypesTable();
    } catch(e) {
        document.getElementById('eventTypesTable').innerHTML =
            '<tr><td colspan="4" style="text-align:center;color:var(--danger)">Failed to load event types</td></tr>';
    }
}

function renderEventTypesTable() {
    const tbody = document.getElementById('eventTypesTable');
    if (!eventTypes.length) { tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:var(--text-muted)">No event types found.</td></tr>'; return; }
    tbody.innerHTML = eventTypes.map(et => `
        <tr class="${!et.is_active ? 'inactive-row' : ''}">
            <td style="font-weight:600;color:white">${esc(et.name)}</td>
            <td style="color:var(--text-muted);font-size:0.85rem">${esc(et.description || '—')}</td>
            <td><span class="status-badge ${et.is_active ? 'status-active' : 'status-inactive'}">${et.is_active ? 'Active' : 'Inactive'}</span></td>
            <td>
                <div class="action-btns">
                    <button class="btn-sm btn-edit" onclick="editEventType(${et.id})"><i class="fa-solid fa-pen"></i></button>
                    ${et.is_active
                        ? `<button class="btn-sm btn-delete" onclick="softDeleteEventType(${et.id},'${esc(et.name)}')"><i class="fa-solid fa-eye-slash"></i></button>`
                        : `<button class="btn-sm btn-restore" onclick="restoreEventType(${et.id},'${esc(et.name)}')"><i class="fa-solid fa-eye"></i></button>`
                    }
                </div>
            </td>
        </tr>`).join('');
}

async function addEventType() {
    const btn = document.getElementById('addEventTypeBtn');
    const name = document.getElementById('etName').value.trim();
    const desc = document.getElementById('etDesc').value.trim();
    if (!name) { showToast('Name is required', 'error'); return; }

    btn.disabled = true; btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Adding...';
    try {
        const res = await fetch(API.createEventType, {
            method: 'POST', headers: getAuthHeaders(),
            body: JSON.stringify(withRole({ name, description: desc || null }))
        });
        if (!res.ok) { const e = await res.json().catch(() => ({})); throw new Error(e.error || 'Failed'); }
        showToast('Event type added!');
        document.getElementById('etName').value = '';
        document.getElementById('etDesc').value = '';
        await loadEventTypes();
    } catch(e) { showToast(e.message || 'Error adding event type', 'error'); }
    finally { btn.disabled = false; btn.innerHTML = '<i class="fa-solid fa-plus"></i> Add Event Type'; }
}

function editEventType(id) {
    const et = eventTypes.find(x => x.id == id);
    if (!et) return;
    modalMode = { type: 'event', id, data: et };
    document.getElementById('modalTitle').textContent = 'Edit Event Type — ' + et.name;
    document.getElementById('modalBody').innerHTML = `
        <div class="input-group"><label>Name</label><input type="text" id="me_name" value="${esc(et.name)}"></div>
        <div class="input-group"><label>Description</label><textarea id="me_desc">${esc(et.description || '')}</textarea></div>
        <div class="toggle-row">
            <span class="toggle-label">Active</span>
            <button class="toggle ${et.is_active ? 'on' : ''}" id="me_active" onclick="this.classList.toggle('on')"></button>
        </div>`;
    document.getElementById('editModal').classList.add('open');
}

async function softDeleteEventType(id, name) {
    if (!confirm(`Deactivate "${name}"?`)) return;
    try {
        await fetch(API.deleteEventType, { method: 'POST', headers: getAuthHeaders(), body: JSON.stringify(withRole({ event_type_id: id })) });
        showToast('Event type deactivated');
        await loadEventTypes();
    } catch(e) { showToast('Error', 'error'); }
}

async function restoreEventType(id, name) {
    if (!confirm(`Re-activate "${name}"?`)) return;
    const et = eventTypes.find(x => x.id == id);
    if (!et) return;
    try {
        await fetch(API.updateEventType, {
            method: 'POST', headers: getAuthHeaders(),
            body: JSON.stringify(withRole({ ...et, id, is_active: true }))
        });
        showToast('Event type re-activated');
        await loadEventTypes();
    } catch(e) { showToast('Error', 'error'); }
}

function closeModal() {
    document.getElementById('editModal').classList.remove('open');
    modalMode = null;
}

// ─────────────────────────────────────────────
// PRICING GRID
// ─────────────────────────────────────────────
async function loadPricing() {
    try {
        const res = await fetch(API.getPricing, { headers: getAuthHeaders() });
        const json = await res.json();
        pricing = json.data || (Array.isArray(json) ? json : []);
    } catch(e) { pricing = []; }
}

function renderPricingGrid() {
    const wrap = document.getElementById('pricingGridWrap');
    const activeRooms = rooms.filter(r => r.is_active);
    const activeTypes = eventTypes.filter(et => et.is_active);

    if (!activeRooms.length || !activeTypes.length) {
        wrap.innerHTML = '<p style="color:var(--text-muted);padding:2rem;text-align:center">Add rooms and event types first to configure pricing.</p>';
        return;
    }

    // Build lookup map: "room_id-event_type_id" → day_rate
    const priceMap = {};
    pricing.forEach(p => { priceMap[`${p.room_id}-${p.event_type_id}`] = p.day_rate; });

    let html = `<table class="pricing-grid">
        <thead><tr>
            <th>Room</th>
            ${activeTypes.map(et => `<th>${esc(et.name)}</th>`).join('')}
        </tr></thead>
        <tbody>`;

    activeRooms.forEach(r => {
        html += `<tr><td class="room-label">${esc(r.name)}<span class="rate-default">Default: ${fmt(r.day_rate)}</span></td>`;
        activeTypes.forEach(et => {
            const key = `${r.id}-${et.id}`;
            const val = priceMap[key] != null ? parseFloat(priceMap[key]) : '';
            html += `<td class="pricing-cell">
                <input class="price-input" type="number" min="0" step="0.01"
                    placeholder="${parseFloat(r.day_rate).toFixed(0)}"
                    value="${val}"
                    data-room="${r.id}" data-type="${et.id}"
                    oninput="this.classList.add('unsaved')"
                    onblur="savePricingCell(this)">
            </td>`;
        });
        html += `</tr>`;
    });

    html += `</tbody></table>
    <p style="margin-top:1rem;font-size:0.8rem;color:var(--text-muted)">
        <i class="fa-solid fa-circle-info"></i> Changes save automatically when you leave a cell. Blank = use room default rate.
    </p>`;
    wrap.innerHTML = html;
}

async function savePricingCell(input) {
    if (!input.classList.contains('unsaved')) return;
    const room_id = input.dataset.room;
    const event_type_id = input.dataset.type;
    const val = input.value.trim();

    // Blank = remove override (use room default) — not implemented in this version
    if (val === '') { input.classList.remove('unsaved'); return; }

    const day_rate = parseFloat(val);
    if (isNaN(day_rate) || day_rate < 0) { showToast('Invalid price', 'error'); return; }

    try {
        const res = await fetch(API.setPricing, {
            method: 'POST', headers: getAuthHeaders(),
            body: JSON.stringify(withRole({ room_id, event_type_id, day_rate }))
        });
        if (!res.ok) throw new Error('Failed');
        input.classList.remove('unsaved');
        // Refresh local pricing cache silently
        await loadPricing();
    } catch(e) { showToast('Failed to save price', 'error'); }
}

// ─────────────────────────────────────────────
// SETTINGS
// ─────────────────────────────────────────────
async function loadSettings() {
    document.getElementById('bufferCurrentText').textContent = 'Loading...';
    try {
        const res = await fetch(API.getSettings, { headers: getAuthHeaders() });
        const json = await res.json();
        settings = json.data || (Array.isArray(json) ? json : []);
        const bufferSetting = settings.find(s => s.key === 'booking_buffer_minutes');
        const currentVal = bufferSetting ? parseInt(bufferSetting.value) : 60;
        // Update info text
        document.getElementById('bufferCurrentText').textContent =
            `Current: ${currentVal === 0 ? 'No buffer' : currentVal + ' minutes'} — last updated ${bufferSetting ? new Date(bufferSetting.updated_at).toLocaleString('en-GB') : 'never'}`;
        // Set select to matching value
        const sel = document.getElementById('bufferSelect');
        const knownValues = ['0','30','45','60','90','120'];
        if (knownValues.includes(String(currentVal))) {
            sel.value = String(currentVal);
            document.getElementById('customBufferGroup').style.display = 'none';
        } else {
            sel.value = 'custom';
            document.getElementById('customBufferInput').value = currentVal;
            document.getElementById('customBufferGroup').style.display = 'block';
        }
    } catch(e) {
        document.getElementById('bufferCurrentText').textContent = 'Failed to load settings.';
    }
}

function handleBufferSelectChange() {
    const sel = document.getElementById('bufferSelect');
    document.getElementById('customBufferGroup').style.display =
        sel.value === 'custom' ? 'block' : 'none';
}

async function saveBufferSetting() {
    const sel = document.getElementById('bufferSelect');
    let minutes;
    if (sel.value === 'custom') {
        minutes = parseInt(document.getElementById('customBufferInput').value);
        if (isNaN(minutes) || minutes < 0) { showToast('Invalid minutes value', 'error'); return; }
    } else {
        minutes = parseInt(sel.value);
    }
    const btn = document.getElementById('saveBufferBtn');
    btn.disabled = true; btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Saving...';
    try {
        const res = await fetch(API.updateSetting, {
            method: 'POST', headers: getAuthHeaders(),
            body: JSON.stringify({ key: 'booking_buffer_minutes', value: minutes })
        });
        if (!res.ok) throw new Error('Save failed');
        showToast(`Buffer set to ${minutes === 0 ? 'no buffer' : minutes + ' minutes'}`);
        await loadSettings();
    } catch(e) { showToast('Failed to save setting', 'error'); }
    finally { btn.disabled = false; btn.innerHTML = '<i class="fa-solid fa-floppy-disk"></i> Save Buffer Setting'; }
}

// ─────────────────────────────────────────────
// ESCAPE HELPER
// ─────────────────────────────────────────────
function esc(str) {
    if (!str) return '';
    return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// ─────────────────────────────────────────────
// INIT
// ─────────────────────────────────────────────
async function init() {
    await Promise.all([loadRooms(), loadEventTypes(), loadPricing(), loadSettings()]);
}

init();
</script>
</body>
</html>
